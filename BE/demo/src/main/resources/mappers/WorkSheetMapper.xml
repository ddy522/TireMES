<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.WorkSheetMapper">

    <!-- 컬럼명(snake_case) ↔ DTO 필드(camelCase) 명시 매핑 -->
    <resultMap id="WorkSheetMap" type="com.example.demo.model.WorkSheetModel">
        <result column="work_no"     property="workNo"/>
        <result column="deadline"    property="deadline"/>
        <result column="priority"    property="priority"/>
        <result column="part_code"   property="partCode"/>
        <result column="process_code" property="processCode"/>
        <result column="qty"         property="qty"/>
        <result column="work_state"  property="workStatus"/>
        <result column="part_name"   property="partName"/>
        <result column="process_name_eng"  property="processNameEng"/>
        <result column="worksheetSkey"  property="worksheetSkey"/>
    </resultMap>

    <!--전체 작업지시 조회 -->
    <select id="findAllWorkList" resultMap="WorkSheetMap">
        SELECT
            w.work_no,
            w.deadline,
            w.priority,
            w.part_code,
            w.process_code,
            w.qty,
            w.work_state,
            p.part_name,
            w.skey as worksheetSkey,
            p.std
        FROM worksheet w
        LEFT JOIN part p ON w.part_code = p.part_code
        WHERE w.useyn = 'Y'
    </select>

    <!--공정별 작업지시 조회  : process_name_eng 받아서 -->
    <select id="findByProcessNameEng" parameterType = "string" resultMap="WorkSheetMap">
        SELECT
        w.work_no,
        w.deadline,
        w.priority,
        w.part_code,
        w.process_code,
        w.qty,
        w.work_state,
        p.part_name,
        pr.process_name_eng,
        w.skey as worksheetSkey,
        p.std
        FROM worksheet w
        LEFT JOIN part p
        ON w.part_code = p.part_code
        LEFT JOIN `process` pr
        ON w.process_code = pr.process_no
        WHERE pr.process_name_eng = #{processNameEng}
        AND w.useyn = 'Y'
    </select>

    <!-- 추가: 선택 조건 검색 -->
    <select id="searchWorkSheets" resultMap="WorkSheetMap">
        SELECT
        w.work_no,
        /* DATETIME → 문자열 표시가 필요하면 다음 줄 사용, 아니면 w.deadline 그대로 */
        DATE_FORMAT(w.deadline, '%Y-%m-%d') AS deadline,
        w.priority,
        w.part_code,
        w.process_code,
        w.qty,
        w.work_state,
        p.part_name,
        pr.process_name_eng,
        p.std
        FROM worksheet w
        LEFT JOIN part p
        ON w.part_code = p.part_code
        LEFT JOIN `process` pr
        ON w.process_code = pr.process_no
        <where>
            <if test="processNameEng != null and processNameEng != ''">
                AND pr.process_name_eng = #{processNameEng}
            </if>
            <if test="partCode != null and partCode != ''">
                AND w.part_code = #{partCode}
            </if>
            <if test="workStatus != null and workStatus != ''">
                <!-- work_state 타입(숫자/문자) 불일치 시 아래 한 줄로 교체
                AND CAST(w.work_state AS CHAR) = #{workStatus} -->
                AND w.work_state = #{workStatus}
            </if>
            <if test="workNo != null and workNo != ''">
                AND w.work_no LIKE CONCAT('%', #{workNo}, '%')
            </if>
            AND w.useyn = 'Y'
        </where>
        ORDER BY w.deadline ASC, w.work_no DESC
    </select>

</mapper>


<!--        상태 셀렉트 값이 문자이고 컬럼은 숫자면 CAST(w.work_state AS CHAR)-->